generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE USER & AUTH
// ============================================================================

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  name       String
  role       UserRole @default(user)
  password   String   // argon2 hashed
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Financial
  deposit_addresses deposit_addresses[]
  transactions      transactions[]
  investments       ipo_investments[]

  // Creator (1:1 relations)
  creator_profile     creator_profiles?
  creator_application creator_applications?
  creator_token       creator_token?
  creator_ipo         creator_ipos?

  // Denormalized for query performance - allows direct user_id lookups
  creator_documents    creator_documents[]
  creator_social_links creator_social_links[]
  verification_logs    verification_logs[]

  // Admin
  reviewed_ipos creator_ipos[] @relation("IpoReviewer")

  @@index([email])
  @@index([role])
  @@map("users")
}

// ============================================================================
// FINANCIAL
// ============================================================================

model deposit_addresses {
  id           String         @id @default(uuid())
  user_id      Int
  chain        Chain
  currency     Currency
  address      String?        @unique // Generated asynchronously
  is_active    Boolean        @default(true)
  created_at   DateTime       @default(now())
  user         User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transactions transactions[]

  @@unique([user_id, chain, currency]) // One address per user-chain-currency
  @@index([user_id])
  @@index([chain])
  @@index([currency])
  @@index([is_active])
  @@map("deposit_addresses")
}

model transactions {
  id                 String             @id @default(uuid())
  user_id            Int
  wallet_id          String?
  type               TransactionType
  currency           Currency
  amount             Decimal            @db.Decimal(18, 9)
  status             TransactionStatus  @default(pending)
  blockchain_hash    String?            @unique
  confirmations      Int?
  deposit_address_id String?
  created_at         DateTime           @default(now())
  updated_at         DateTime           @updatedAt
  user               User               @relation(fields: [user_id], references: [id], onDelete: Cascade)
  deposit_address    deposit_addresses? @relation(fields: [deposit_address_id], references: [id])

  @@index([user_id])
  @@index([type])
  @@index([status])
  @@index([currency])
  @@index([created_at])
  @@index([wallet_id])
  @@map("transactions")
}

// ============================================================================
// CREATOR VERIFICATION
// ============================================================================

// Workflow: pending_submission → submitted → under_review → approved/rejected
model creator_applications {
  id                         String           @id @default(uuid())
  user_id                    Int              @unique
  state                      ApplicationState @default(pending_submission)
  content_ownership_declared Boolean          @default(false)
  rejection_reason           String?          @db.Text
  submitted_at               DateTime         @default(now())
  reviewed_at                DateTime?
  approved_at                DateTime?
  user                       User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  creator_profile            creator_profiles?

  @@index([state])
  @@index([submitted_at])
  @@map("creator_applications")
}

model creator_profiles {
  id             String          @id @default(uuid())
  user_id        Int             @unique
  application_id String          @unique // Links to approved application
  full_name      String
  creator_handle String          @unique
  bio            String          @db.Text
  phone_number   String?
  profile_picture String?
  category       CreatorCategory
  custom_category String?
  token_name     String
  token_symbol   String          @unique
  token_pitch    String          @db.Text
  wallet         String
  funding_goal   Decimal?        @db.Decimal(18, 2)
  ico_supply     BigInt?
  status         CreatorStatus   @default(pending)
  engagement_metrics Json?
  created_at     DateTime        @default(now())
  updated_at     DateTime        @updatedAt
  user           User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  application    creator_applications @relation(fields: [application_id], references: [id], onDelete: Restrict)
  documents      creator_documents[]
  social_links   creator_social_links[]
  verification_logs verification_logs[]
  token          creator_token?
  ipo            creator_ipos?

  @@index([user_id])
  @@index([creator_handle])
  @@index([token_symbol])
  @@index([status])
  @@index([category])
  @@map("creator_profiles")
}

model creator_documents {
  id         String         @id @default(uuid())
  user_id    Int            // Denormalized for fast user queries
  profile_id String
  type       DocumentType
  file_url   String
  status     DocumentStatus @default(pending)
  notes      String?        @db.Text // Admin review notes
  created_at DateTime       @default(now())
  updated_at DateTime       @updatedAt
  user       User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  profile    creator_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([profile_id])
  @@index([status])
  @@index([type])
  @@map("creator_documents")
}

model creator_social_links {
  id             String         @id @default(uuid())
  user_id        Int            // Denormalized for fast user queries
  profile_id     String
  platform       SocialPlatform
  handle         String
  url            String
  follower_count Int?
  verified       Boolean        @default(false)
  created_at     DateTime       @default(now())
  updated_at     DateTime       @updatedAt
  user           User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  profile        creator_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@unique([profile_id, platform]) // One platform per creator
  @@index([user_id])
  @@index([profile_id])
  @@index([platform])
  @@index([verified])
  @@map("creator_social_links")
}

model verification_logs {
  id         String   @id @default(uuid())
  user_id    Int      // Denormalized for fast user queries
  profile_id String
  action     String
  actor      String   // User ID or "system"
  metadata   Json?
  created_at DateTime @default(now())
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  profile    creator_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([profile_id])
  @@index([action])
  @@index([created_at])
  @@map("verification_logs")
}

model creator_token {
  id           String   @id @default(uuid())
  user_id      Int      @unique
  profile_id   String   @unique
  name         String
  symbol       String   @unique
  total_supply BigInt
  mint_address String   @unique // On-chain contract address
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  profile      creator_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([profile_id])
  @@index([symbol])
  @@map("creator_tokens")
}

// ============================================================================
// IPO SYSTEM
// ============================================================================

// Workflow: draft → pending_review → under_review → approved → live → closed → successful/failed
model creator_ipos {
  id         String @id @default(uuid())
  user_id    Int    @unique
  profile_id String @unique
  
  // Basic info
  title       String
  description String @db.Text
  
  // Token economics
  total_tokens        BigInt
  tokens_for_sale     BigInt
  price_per_token     Decimal    @db.Decimal(18, 9)
  min_purchase        Decimal    @db.Decimal(18, 9)
  max_purchase        Decimal?   @db.Decimal(18, 9)
  accepted_currencies Currency[]
  
  // Fundraising
  soft_cap Decimal @db.Decimal(18, 2) // Minimum - refunded if not reached
  hard_cap Decimal @db.Decimal(18, 2) // Maximum - closes when reached
  
  // Timeline
  start_date DateTime
  end_date   DateTime
  
  // Vesting - prevents immediate token dumping
  vesting_period   Int?  // Days
  vesting_schedule Json? // {cliff: 90, duration: 365, intervals: 12}
  
  // Status
  status           IpoStatus @default(draft)
  rejection_reason String?   @db.Text
  
  // Planning
  milestones   Json?
  roadmap      String? @db.Text
  use_of_funds Json // {development: 40%, marketing: 30%, operations: 30%}
  
  // Legal
  terms_conditions String  @db.Text
  risk_disclosure  String  @db.Text
  whitepaper_url   String?
  pitch_deck_url   String?
  
  // Admin review
  submitted_at DateTime?
  reviewed_at  DateTime?
  approved_at  DateTime?
  launched_at  DateTime?
  reviewed_by  Int?
  
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  
  user        User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  profile     creator_profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  reviewer    User?            @relation("IpoReviewer", fields: [reviewed_by], references: [id])
  investments ipo_investments[]
  updates     ipo_updates[]

  @@index([user_id])
  @@index([profile_id])
  @@index([status])
  @@index([start_date])
  @@index([end_date])
  @@index([reviewed_by])
  @@map("creator_ipos")
}

model ipo_investments {
  id          String @id @default(uuid())
  ipo_id      String
  investor_id Int
  
  // Investment
  amount           Decimal  @db.Decimal(18, 9)
  currency         Currency
  tokens_allocated BigInt
  
  // Blockchain
  transaction_hash   String?           @unique
  transaction_status TransactionStatus @default(pending)
  
  // Vesting
  tokens_claimed  BigInt    @default(0)
  last_claim_date DateTime?
  next_claim_date DateTime?
  
  invested_at DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  ipo      creator_ipos @relation(fields: [ipo_id], references: [id], onDelete: Cascade)
  investor User         @relation(fields: [investor_id], references: [id], onDelete: Cascade)

  @@index([ipo_id])
  @@index([investor_id])
  @@index([transaction_status])
  @@index([invested_at])
  @@map("ipo_investments")
}

model ipo_updates {
  id         String     @id @default(uuid())
  ipo_id     String
  title      String
  content    String     @db.Text
  type       UpdateType @default(general)
  created_at DateTime   @default(now())
  ipo        creator_ipos @relation(fields: [ipo_id], references: [id], onDelete: Cascade)

  @@index([ipo_id])
  @@index([type])
  @@index([created_at])
  @@map("ipo_updates")
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  user
  creator
  admin
}

enum Currency {
  USDC
  SOL
  ETH
  BTC
}

enum Chain {
  solana
  ethereum
  polygon
}

enum TransactionType {
  deposit
  withdrawal
  transfer
}

enum TransactionStatus {
  pending
  confirmed
  failed
}

enum CreatorCategory {
  artist
  musician
  writer
  developer
  influencer
  entrepreneur
  other
}

enum CreatorStatus {
  pending
  active
  inactive
  suspended
}

enum ApplicationState {
  pending_submission
  submitted
  under_review
  approved
  rejected
}

enum DocumentType {
  identity
  proof_of_address
  business_license
  tax_document
  other
}

enum DocumentStatus {
  pending
  approved
  rejected
}

enum SocialPlatform {
  twitter
  instagram
  youtube
  tiktok
  linkedin
  facebook
  other
}

enum IpoStatus {
  draft
  pending_review
  under_review
  approved
  live
  closed
  successful
  failed
  cancelled
  rejected
}

enum UpdateType {
  general
  milestone
  financial
  technical
  announcement
}